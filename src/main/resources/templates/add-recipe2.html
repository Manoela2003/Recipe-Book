<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/head :: head('Add Recipe | Recipe Book')}"/>
    <link rel="stylesheet" th:href="@{/css/add-recipe2.css}">
</head>
<body>
<div th:replace="~{fragments/nav :: nav}"/>
<div class="container">
    <h2 class="main-heading">Add New Recipe</h2>

    <form th:action="@{/recipes/add}" th:object="${recipe}" method="post" enctype="multipart/form-data">

        <div class="form-group">
            <label for="title">Recipe Title</label>
            <input type="text" id="title" th:field="*{title}" placeholder="Enter recipe name" required>
            <div th:if="${#fields.hasErrors('title')}" class="error-message" th:errors="*{title}"></div>
        </div>

        <div class="form-group">
            <label for="description">Short Description</label>
            <textarea id="description" th:field="*{description}" rows="3" placeholder="Brief summary of the recipe"
                      required></textarea>
            <div th:if="${#fields.hasErrors('description')}" class="error-message" th:errors="*{description}"></div>
        </div>

        <div class="form-group">
            <label for="category">Category</label>
            <select id="category" th:field="*{category}">
                <option value="">-- Select Category --</option>
                <option value="breakfast">Breakfast</option>
                <option value="lunch">Lunch</option>
                <option value="dinner">Dinner</option>
                <option value="dessert">Dessert</option>
                <option value="snack">Snack</option>
            </select>
            <div th:if="${#fields.hasErrors('category')}" class="error-message" th:errors="*{category}"></div>
        </div>

        <div class="form-group">
            <label>Upload Images</label>

            <div id="image-previews" class="image-preview-container">
                <th:block th:if="${tempImages != null}" th:each="image, iterStat : ${tempImages}">
                    <div class="preview-wrapper" th:data-index="${iterStat.index}" th:data-type="temp"
                         onclick="setMainImage(this)" th:classappend="${iterStat.index == recipe.mainImageIndex} ? 'main-image' : ''">
                        <img th:src="${image.url}" alt="Image Preview" class="image-preview"/>
                        <button type="button" class="remove-btn" onclick="removeTempImage(event, this)"
                                aria-label="Remove image">&times;
                        </button>
                        <input type="hidden" name="tempImageIndexes" th:value="${iterStat.index}"/>
                    </div>
                </th:block>
            </div>

            <button type="button" class="add-image-btn" onclick="triggerFileInput()">+ Add Image</button>

            <!-- Only include file input when there are no temp images or when adding new ones -->
            <input type="file" id="images" name="images" accept="image/*" style="display: none;" multiple
                   onchange="handleImageUpload(event)">

            <!-- Hidden inputs for temp image IDs -->
            <th:block th:if="${tempImageIds != null}" th:each="tempId : ${tempImageIds}">
                <input type="hidden" name="tempImageIds" th:value="${tempId}"/>
            </th:block>

            <input type="hidden" name="mainImageIndex" id="mainImageIndex" th:field="*{mainImageIndex}">
        </div>

        <div class="form-group">
            <label>Ingredients</label>
            <div id="ingredient-list" class="dynamic-list">
                <div th:each="ingredient, iterStat : *{ingredients}" class="dynamic-list-item">
                    <input type="text" th:field="*{ingredients[__${iterStat.index}__].name}" placeholder="Ingredient"
                           required>
                    <input type="number" th:field="*{ingredients[__${iterStat.index}__].amount}" step="1" min="0"
                           placeholder="Amount" required>
                    <input type="text" th:field="*{ingredients[__${iterStat.index}__].unit}" placeholder="Unit"
                           required>
                    <button type="button" class="remove-btn" onclick="removeItem(this)" aria-label="Remove item">
                        &times;
                    </button>
                </div>
            </div>
            <div th:if="${#fields.hasErrors('ingredients')}" class="error-message" th:errors="*{ingredients}"></div>
            <button type="button" class="add-btn" onclick="addIngredient()">+ Add Ingredient</button>
        </div>

        <div class="form-group">
            <label>Preparation Steps</label>
            <div id="step-list" class="dynamic-list steps-list">
                <div th:each="step, iterStat : *{instructions}" class="dynamic-list-item">
                    <input type="text" th:field="*{instructions[__${iterStat.index}__]}" placeholder="Describe step"
                           required/>
                    <button type="button" class="remove-btn" onclick="removeItem(this)" aria-label="Remove item">
                        &times;
                    </button>
                </div>
            </div>
            <div th:if="${#fields.hasErrors('instructions')}" class="error-message" th:errors="*{instructions}"></div>
            <button type="button" class="add-btn" onclick="addStep()">+ Add Step</button>
        </div>

        <div class="form-group">
            <label for="prepTime">Preparation Time (minutes)</label>
            <input type="number" id="prepTime" th:field="*{prepTime}" min="0">
            <div th:if="${#fields.hasErrors('prepTime')}" class="error-message" th:errors="*{prepTime}"></div>
        </div>

        <div class="form-group">
            <label for="cookTime">Cooking Time (minutes)</label>
            <input type="number" id="cookTime" th:field="*{cookTime}" min="0">
            <div th:if="${#fields.hasErrors('cookTime')}" class="error-message" th:errors="*{cookTime}"></div>
        </div>

        <div class="form-group">
            <label for="servings">Servings</label>
            <input type="number" id="servings" th:field="*{servings}">
            <div th:if="${#fields.hasErrors('servings')}" class="error-message" th:errors="*{servings}"></div>
        </div>

        <div th:if="${errorMessage}" class="form-error">
            <p th:text="${errorMessage}"></p>
        </div>

        <button class="main-btn" type="submit">Add Recipe</button>

        <template id="ingredient-template">
            <div class="dynamic-list-item">
                <input type="text" name="" placeholder="Ingredient" required>
                <input type="number" name="" step="0.01" min="0" placeholder="Amount" required>
                <input type="text" name="" placeholder="Unit" required>
                <button type="button" class="remove-btn" onclick="removeItem(this)" aria-label="Remove item">&times;
                </button>
            </div>
        </template>
    </form>
</div>

<script>
    function addIngredient() {
        const list = document.getElementById('ingredient-list');
        const template = document.getElementById('ingredient-template');
        const clone = template.content.cloneNode(true);

        const index = list.querySelectorAll('.dynamic-list-item').length;

        const inputs = clone.querySelectorAll('input');
        if (inputs.length >= 3) {
            inputs[0].name = `ingredients[${index}].name`;
            inputs[1].name = `ingredients[${index}].amount`;
            inputs[2].name = `ingredients[${index}].unit`;
        }

        list.appendChild(clone);
    }

    let stepIndex = 1;

    function addStep() {
        const list = document.getElementById('step-list');
        const item = document.createElement('div');
        item.className = 'dynamic-list-item';
        item.setAttribute('data-index', stepIndex);

        item.innerHTML = `
        <input type="text" name="instructions[${stepIndex}]" placeholder="Describe step" required>
        <button type="button" class="remove-btn" onclick="removeItem(this)" aria-label="Remove item">&times;</button>
    `;

        list.appendChild(item);
        stepIndex++;
    }

    const imagePreviews = document.getElementById('image-previews');
    const fileInput = document.getElementById('images');
    const mainImageInput = document.getElementById('mainImageIndex');
    let imageFiles = [];
    let newImageCounter = 0;

    document.addEventListener('DOMContentLoaded', function() {
        const mainImage = document.querySelector('.preview-wrapper.main-image');
        if (mainImage && mainImageInput.value === '') {
            mainImageInput.value = mainImage.dataset.index;
        }

        // Clear the file input if we have temp images (from validation error)
        const tempImages = document.querySelectorAll('.preview-wrapper[data-type="temp"]');
        if (tempImages.length > 0) {
            fileInput.value = '';
            imageFiles = [];
        }
    });

    function triggerFileInput() {
        fileInput.click();
    }

    function handleImageUpload(event) {
        const files = Array.from(event.target.files);
        if (!files.length) return;

        files.forEach(file => {
            imageFiles.push(file);
            displayNewImagePreview(file);
        });

        updateFileInput();
    }

    function displayNewImagePreview(file) {
        const reader = new FileReader();
        const imageId = 'new-' + newImageCounter++;

        reader.onload = function (e) {
            const container = document.createElement('div');
            container.classList.add('preview-wrapper');
            container.setAttribute('data-id', imageId);
            container.setAttribute('data-type', 'new');
            container.onclick = () => setMainImage(container);

            const img = document.createElement('img');
            img.src = e.target.result;
            img.classList.add('image-preview');

            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '&times;';
            removeBtn.className = 'remove-btn';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                removeNewImage(container, imageId);
            };

            container.appendChild(img);
            container.appendChild(removeBtn);
            imagePreviews.appendChild(container);

            // If this is the first image, make it the main image
            if (getAllImages().length === 1) {
                setMainImage(container);
            }
        };

        reader.readAsDataURL(file);
    }

    function setMainImage(element) {
        // Remove main-image class from all images
        getAllImages().forEach(img => {
            img.classList.remove('main-image');
        });

        // Add main-image class to selected element
        element.classList.add('main-image');

        // Update hidden input with the appropriate value
        if (element.dataset.type === 'temp') {
            mainImageInput.value = element.dataset.index;
        } else if (element.dataset.type === 'new') {
            // For new images, we need to find its position among all images
            const allImages = getAllImages();
            const index = Array.from(allImages).indexOf(element);
            mainImageInput.value = index;
        }
    }

    function getAllImages() {
        return imagePreviews.querySelectorAll('.preview-wrapper');
    }

    function removeTempImage(event, button) {
        event.stopPropagation();
        const wrapper = button.closest('.preview-wrapper');
        const wasMainImage = wrapper.classList.contains('main-image');

        // Remove the corresponding hidden input
        const tempImageIndex = wrapper.getAttribute('data-index');
        const hiddenInput = wrapper.querySelector('input[name="tempImageIndexes"]');
        if (hiddenInput) {
            hiddenInput.remove();
        }

        // Remove the wrapper
        wrapper.remove();

        // If this was the main image, select a new main image
        if (wasMainImage) {
            const remainingImages = getAllImages();
            if (remainingImages.length > 0) {
                setMainImage(remainingImages[0]);
            } else {
                mainImageInput.value = '';
            }
        }
    }

    function removeNewImage(container, imageId) {
        const wasMainImage = container.classList.contains('main-image');

        // Find and remove the file from imageFiles array
        const newImageContainers = imagePreviews.querySelectorAll('.preview-wrapper[data-type="new"]');
        const containerIndex = Array.from(newImageContainers).indexOf(container);
        if (containerIndex !== -1) {
            imageFiles.splice(containerIndex, 1);
        }

        // Remove the container
        container.remove();

        // Update the file input
        updateFileInput();

        // If this was the main image, select a new main image
        if (wasMainImage) {
            const remainingImages = getAllImages();
            if (remainingImages.length > 0) {
                setMainImage(remainingImages[0]);
            } else {
                mainImageInput.value = '';
            }
        }
    }

    function updateFileInput() {
        const dataTransfer = new DataTransfer();
        imageFiles.forEach(file => dataTransfer.items.add(file));
        fileInput.files = dataTransfer.files;
    }

    function removeItem(button) {
        const item = button.parentElement;
        item.remove();
    }
</script>
</body>
</html>