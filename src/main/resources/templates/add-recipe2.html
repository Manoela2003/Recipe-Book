<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/head :: head('Add Recipe | Recipe Book')}"/>
    <link rel="stylesheet" th:href="@{/css/add-recipe2.css}">
</head>
<body>
<div th:replace="~{fragments/nav :: nav}"/>
<div class="container">
    <h2 class="main-heading">Add New Recipe</h2>

    <form th:action="@{/recipes/add}" th:object="${recipe}" method="post" enctype="multipart/form-data">

        <div class="form-group">
            <label for="title">Recipe Title</label>
            <input type="text" id="title" th:field="*{title}" placeholder="Enter recipe name" required>
            <div th:if="${#fields.hasErrors('title')}" class="error-message" th:errors="*{title}"></div>
        </div>

        <div class="form-group">
            <label for="description">Short Description</label>
            <textarea id="description" th:field="*{description}" rows="3" placeholder="Brief summary of the recipe"
                      required></textarea>
            <div th:if="${#fields.hasErrors('description')}" class="error-message" th:errors="*{description}"></div>
        </div>

        <div class="form-group">
            <label for="primaryCategory">Primary Category</label>
            <select id="primaryCategory" th:field="*{primaryCategory}">
                <option value="">-- Select Category --</option>
                <option th:each="category : ${T(recipes.recipeBook.entity.RecipeCategory).values()}"
                        th:value="${category}"
                        th:text="${category.displayName}">
                </option>
            </select>
            <div th:if="${#fields.hasErrors('primaryCategory')}" class="error-message" th:errors="*{primaryCategory}"></div>
        </div>

        <div class="form-group">
            <label for="tag-input">Tags (Optional)</label>
            <div class="tag-input-container">
                <div id="selected-tags" class="selected-tags">
                    <span th:each="tagName, iterStat : *{tagNames}" class="tag-chip" th:text="${tagName}">
                        <button type="button" class="tag-remove" onclick="removeTag(this)" th:data-tag="${tagName}">&times;</button>
                        <input type="hidden" th:field="*{tagNames[__${iterStat.index}__]}">
                    </span>
                </div>
                <input type="text" id="tag-input" placeholder="Add tags (cuisine, dietary, cooking method...)"
                       autocomplete="off" onkeydown="handleTagInput(event)" oninput="showTagSuggestions(this.value)">
                <div id="tag-suggestions" class="tag-suggestions"></div>
            </div>
            <div class="popular-tags">
                <span>Popular tags:</span>
                <button type="button" class="popular-tag" onclick="addPopularTag('Vegetarian')">Vegetarian</button>
                <button type="button" class="popular-tag" onclick="addPopularTag('Quick & Easy')">Quick & Easy</button>
                <button type="button" class="popular-tag" onclick="addPopularTag('Healthy')">Healthy</button>
                <button type="button" class="popular-tag" onclick="addPopularTag('Italian')">Italian</button>
                <button type="button" class="popular-tag" onclick="addPopularTag('One-Pot')">One-Pot</button>
            </div>
        </div>

        <div class="form-group">
            <label>Upload Images</label>

            <div id="image-previews" class="image-preview-container">
                <th:block th:if="${tempImages != null}" th:each="image, iterStat : ${tempImages}">
                    <div class="preview-wrapper" th:data-index="${iterStat.index}" th:data-type="temp"
                         onclick="setMainImage(this)" th:classappend="${iterStat.index == recipe.mainImageIndex} ? 'main-image' : ''">
                        <img th:src="${image.url}" alt="Image Preview" class="image-preview"/>
                        <button type="button" class="remove-btn" onclick="removeTempImage(event, this)"
                                aria-label="Remove image">&times;
                        </button>
                        <input type="hidden" name="tempImageIndexes" th:value="${iterStat.index}"/>
                    </div>
                </th:block>
            </div>

            <button type="button" class="add-image-btn" onclick="triggerFileInput()">+ Add Image</button>

            <!-- Only include file input when there are no temp images or when adding new ones -->
            <input type="file" id="images" name="images" accept="image/*" style="display: none;" multiple
                   onchange="handleImageUpload(event)">

            <!-- Hidden inputs for temp image IDs -->
            <th:block th:if="${tempImageIds != null}" th:each="tempId : ${tempImageIds}">
                <input type="hidden" name="tempImageIds" th:value="${tempId}"/>
            </th:block>

            <input type="hidden" name="mainImageIndex" id="mainImageIndex" th:field="*{mainImageIndex}">
        </div>

        <div class="form-group">
            <label>Ingredients</label>
            <div id="ingredient-list" class="dynamic-list">
                <div th:each="ingredient, iterStat : *{ingredients}" class="dynamic-list-item">
                    <input type="text" th:field="*{ingredients[__${iterStat.index}__].name}" placeholder="Ingredient"
                           required>
                    <input type="number" th:field="*{ingredients[__${iterStat.index}__].amount}" step="1" min="0"
                           placeholder="Amount" required>
                    <input type="text" th:field="*{ingredients[__${iterStat.index}__].unit}" placeholder="Unit"
                           required>
                    <button type="button" class="remove-btn" onclick="removeItem(this)" aria-label="Remove item">
                        &times;
                    </button>
                </div>
            </div>
            <div th:if="${#fields.hasErrors('ingredients')}" class="error-message" th:errors="*{ingredients}"></div>
            <button type="button" class="add-btn" onclick="addIngredient()">+ Add Ingredient</button>
        </div>

        <div class="form-group">
            <label>Preparation Steps</label>
            <div id="step-list" class="dynamic-list steps-list">
                <div th:each="step, iterStat : *{instructions}" class="dynamic-list-item">
                    <input type="text" th:field="*{instructions[__${iterStat.index}__]}" placeholder="Describe step"
                           required/>
                    <button type="button" class="remove-btn" onclick="removeItem(this)" aria-label="Remove item">
                        &times;
                    </button>
                </div>
            </div>
            <div th:if="${#fields.hasErrors('instructions')}" class="error-message" th:errors="*{instructions}"></div>
            <button type="button" class="add-btn" onclick="addStep()">+ Add Step</button>
        </div>

        <div class="form-group">
            <label for="prepTime">Preparation Time (minutes)</label>
            <input type="number" id="prepTime" th:field="*{prepTime}" min="0">
            <div th:if="${#fields.hasErrors('prepTime')}" class="error-message" th:errors="*{prepTime}"></div>
        </div>

        <div class="form-group">
            <label for="cookTime">Cooking Time (minutes)</label>
            <input type="number" id="cookTime" th:field="*{cookTime}" min="0">
            <div th:if="${#fields.hasErrors('cookTime')}" class="error-message" th:errors="*{cookTime}"></div>
        </div>

        <div class="form-group">
            <label for="servings">Servings</label>
            <input type="number" id="servings" th:field="*{servings}">
            <div th:if="${#fields.hasErrors('servings')}" class="error-message" th:errors="*{servings}"></div>
        </div>

        <div th:if="${errorMessage}" class="form-error">
            <p th:text="${errorMessage}"></p>
        </div>

        <button class="main-btn" type="submit">Add Recipe</button>

        <template id="ingredient-template">
            <div class="dynamic-list-item">
                <input type="text" name="" placeholder="Ingredient" required>
                <input type="number" name="" step="0.01" min="0" placeholder="Amount" required>
                <input type="text" name="" placeholder="Unit" required>
                <button type="button" class="remove-btn" onclick="removeItem(this)" aria-label="Remove item">&times;
                </button>
            </div>
        </template>
    </form>
</div>

<script>
    function addIngredient() {
        const list = document.getElementById('ingredient-list');
        const template = document.getElementById('ingredient-template');
        const clone = template.content.cloneNode(true);

        const index = list.querySelectorAll('.dynamic-list-item').length;

        const inputs = clone.querySelectorAll('input');
        if (inputs.length >= 3) {
            inputs[0].name = `ingredients[${index}].name`;
            inputs[1].name = `ingredients[${index}].amount`;
            inputs[2].name = `ingredients[${index}].unit`;
        }

        list.appendChild(clone);
    }

    let stepIndex = 1;

    function addStep() {
        const list = document.getElementById('step-list');
        const item = document.createElement('div');
        item.className = 'dynamic-list-item';
        item.setAttribute('data-index', stepIndex);

        item.innerHTML = `
        <input type="text" name="instructions[${stepIndex}]" placeholder="Describe step" required>
        <button type="button" class="remove-btn" onclick="removeItem(this)" aria-label="Remove item">&times;</button>
    `;

        list.appendChild(item);
        stepIndex++;
    }

    const imagePreviews = document.getElementById('image-previews');
    const fileInput = document.getElementById('images');
    const mainImageInput = document.getElementById('mainImageIndex');
    let imageFiles = [];
    let newImageCounter = 0;

    document.addEventListener('DOMContentLoaded', function() {
        loadAvailableTags();

        const mainImage = document.querySelector('.preview-wrapper.main-image');
        if (mainImage && mainImageInput.value === '') {
            mainImageInput.value = mainImage.dataset.index;
        }

        const tempImages = document.querySelectorAll('.preview-wrapper[data-type="temp"]');
        if (tempImages.length > 0) {
            fileInput.value = '';
            imageFiles = [];
            newImageCounter = tempImages.length;
        }
    });

    function triggerFileInput() {
        fileInput.click();
    }

    function handleImageUpload(event) {
        const files = Array.from(event.target.files);
        if (!files.length) return;

        files.forEach(file => {
            imageFiles.push(file);
            displayNewImagePreview(file);
        });

        updateFileInput();
    }

    function displayNewImagePreview(file) {
        const reader = new FileReader();
        const imageId = 'new-' + newImageCounter++;

        reader.onload = function (e) {
            const container = document.createElement('div');
            container.classList.add('preview-wrapper');
            container.setAttribute('data-id', imageId);
            container.setAttribute('data-type', 'new');
            container.onclick = () => setMainImage(container);

            const img = document.createElement('img');
            img.src = e.target.result;
            img.classList.add('image-preview');

            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '&times;';
            removeBtn.className = 'remove-btn';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                removeNewImage(container, imageId);
            };

            container.appendChild(img);
            container.appendChild(removeBtn);
            imagePreviews.appendChild(container);

            if (getAllImages().length === 1) {
                setMainImage(container);
            }
        };

        reader.readAsDataURL(file);
    }

    function setMainImage(element) {
        getAllImages().forEach(img => {
            img.classList.remove('main-image');
        });

        element.classList.add('main-image');

        if (element.dataset.type === 'temp') {
            mainImageInput.value = element.dataset.index;
        } else if (element.dataset.type === 'new') {
            const tempImages = document.querySelectorAll('.preview-wrapper[data-type="temp"]');
            const newImages = document.querySelectorAll('.preview-wrapper[data-type="new"]');
            const newImageIndex = Array.from(newImages).indexOf(element);
            mainImageInput.value = tempImages.length + newImageIndex;
        }
    }

    function getAllImages() {
        return imagePreviews.querySelectorAll('.preview-wrapper');
    }

    function removeTempImage(event, button) {
        event.stopPropagation();
        const wrapper = button.closest('.preview-wrapper');
        const wasMainImage = wrapper.classList.contains('main-image');

        const tempImageIndex = wrapper.getAttribute('data-index');
        const hiddenInput = wrapper.querySelector('input[name="tempImageIndexes"]');
        if (hiddenInput) {
            hiddenInput.remove();
        }

        wrapper.remove();

        if (wasMainImage) {
            const remainingImages = getAllImages();
            if (remainingImages.length > 0) {
                setMainImage(remainingImages[0]);
            } else {
                mainImageInput.value = '';
            }
        }
    }

    function removeNewImage(container, imageId) {
        const wasMainImage = container.classList.contains('main-image');

        const newImageContainers = imagePreviews.querySelectorAll('.preview-wrapper[data-type="new"]');
        const containerIndex = Array.from(newImageContainers).indexOf(container);
        if (containerIndex !== -1) {
            imageFiles.splice(containerIndex, 1);
        }

        container.remove();

        updateFileInput();

        if (wasMainImage) {
            const remainingImages = getAllImages();
            if (remainingImages.length > 0) {
                setMainImage(remainingImages[0]);
            } else {
                mainImageInput.value = '';
            }
        }
    }

    function updateFileInput() {
        const dataTransfer = new DataTransfer();
        imageFiles.forEach(file => dataTransfer.items.add(file));
        fileInput.files = dataTransfer.files;
    }

    function removeItem(button) {
        const item = button.parentElement;
        item.remove();
    }

    let availableTags = [];

    function loadAvailableTags() {
        fetch('/api/tags/search?query=')
            .then(response => response.json())
            .then(tags => {
                availableTags = tags;
            })
            .catch(error => console.error('Error loading tags:', error));
    }

    function handleTagInput(event) {
        if (event.key === 'Enter' || event.key === ',') {
            event.preventDefault();
            const input = event.target;
            const tagName = input.value.trim();
            if (tagName) {
                addTag(tagName);
                input.value = '';
                hideSuggestions();
            }
        } else if (event.key === 'Escape') {
            hideSuggestions();
        }
    }

    function showTagSuggestions(query) {
        const suggestionsDiv = document.getElementById('tag-suggestions');

        if (!query.trim()) {
            hideSuggestions();
            return;
        }

        const filteredTags = availableTags.filter(tag =>
            tag.name.toLowerCase().includes(query.toLowerCase()) &&
            !isTagSelected(tag.name)
        );

        if (filteredTags.length === 0) {
            hideSuggestions();
            return;
        }

        suggestionsDiv.innerHTML = '';
        filteredTags.slice(0, 8).forEach(tag => {
            const suggestion = document.createElement('div');
            suggestion.className = 'tag-suggestion';
            suggestion.textContent = tag.name;
            suggestion.onclick = () => {
                addTag(tag.name);
                document.getElementById('tag-input').value = '';
                hideSuggestions();
            };
            suggestionsDiv.appendChild(suggestion);
        });

        suggestionsDiv.style.display = 'block';
    }

    function hideSuggestions() {
        document.getElementById('tag-suggestions').style.display = 'none';
    }

    function addTag(tagName) {
        const trimmedTag = tagName.trim();
        if (!trimmedTag || isTagSelected(trimmedTag)) {
            return;
        }

        const selectedTagsDiv = document.getElementById('selected-tags');
        const currentIndex = document.querySelectorAll('#selected-tags .tag-chip').length;
        const tagChip = document.createElement('span');
        tagChip.className = 'tag-chip';
        tagChip.innerHTML = `
            ${trimmedTag}
            <button type="button" class="tag-remove" onclick="removeTag(this)" data-tag="${trimmedTag}">&times;</button>
            <input type="hidden" name="tagNames[${currentIndex}]" value="${trimmedTag}">
        `;

        selectedTagsDiv.appendChild(tagChip);
    }

    function addPopularTag(tagName) {
        addTag(tagName);
    }

    function removeTag(button) {
        const tagChip = button.closest('.tag-chip');
        tagChip.remove();
        reindexTags();
    }

    function reindexTags() {
        const tagChips = document.querySelectorAll('#selected-tags .tag-chip');
        tagChips.forEach((chip, index) => {
            const hiddenInput = chip.querySelector('input[type="hidden"]');
            if (hiddenInput) {
                hiddenInput.name = `tagNames[${index}]`;
            }
        });
    }

    function isTagSelected(tagName) {
        const selectedTags = document.querySelectorAll('#selected-tags input[type="hidden"]');
        return Array.from(selectedTags).some(input => input.value.toLowerCase() === tagName.toLowerCase());
    }
</script>
</body>
</html>